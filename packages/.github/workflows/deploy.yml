name: ðŸš€ Deploy

on:
    push:
        branches: [ main ]
    workflow_dispatch:

jobs:
    deploy:
        runs-on: ubuntu-latest
        if: github.ref == 'refs/heads/main'

        steps:
        - uses: actions/checkout@v4

        - name: Setup Node.js
            uses: actions/setup-node@v4
            with:
                node-version: '18'
                cache: 'npm'

        - name: Install dependencies
            run: npm ci

        - name: Build
            run: npm run build

        - name: Login to Docker Registry
            uses: docker/login-action@v3
            with:
                registry: ${{ secrets.DOCKER_REGISTRY }}
                username: ${{ secrets.DOCKER_USERNAME }}
                password: ${{ secrets.DOCKER_PASSWORD }}

        - name: Build and push Docker images
            uses: docker/build-push-action@v5
            with:
                context: .
                file: Dockerfile.backend
                push: true
                tags: ${{ secrets.DOCKER_REGISTRY }}/vizzio-backend:latest

        - name: Build and push Frontend image
            uses: docker/build-push-action@v5
            with:
                context: .
                file: Dockerfile.frontend
                push: true
                tags: ${{ secrets.DOCKER_REGISTRY }}/vizzio-frontend:latest

        - name: Deploy to Kubernetes
            if: ${{ secrets.KUBE_CONFIG != '' }}
            run: |
                echo "${{ secrets.KUBE_CONFIG }}" | base64 -d > kubeconfig.yaml
                kubectl --kubeconfig=kubeconfig.yaml apply -f k8s/
                kubectl --kubeconfig=kubeconfig.yaml rollout restart deployment/vizzio-backend
                kubectl --kubeconfig=kubeconfig.yaml rollout restart deployment/vizzio-frontend
                rm -f kubeconfig.yaml

        - name: Notify deployment
            if: always()
            run: |
                curl -X POST "${{ secrets.SLACK_WEBHOOK }}" \
                    -H 'Content-Type: application/json' \
                    -d '{"text":"âœ… Vizzio deployed to production!"}'
