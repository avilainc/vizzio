use crate::internal::PatternMatcher;
use serde::{Deserialize, Serialize};
use std::collections::HashMap;

#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct Signature {
    pub id: String,
    pub name: String,
    pub description: String,
    pub pattern: Vec<u8>,
    pub category: String,
}

#[derive(Debug, Clone)]
pub struct SignatureMatch {
    pub name: String,
    pub description: String,
    pub offset: usize,
}

pub struct SignatureDatabase {
    signatures: Vec<Signature>,
    matcher: PatternMatcher,
}

impl SignatureDatabase {
    pub fn new() -> Self {
        let mut db = Self {
            signatures: Vec::new(),
            matcher: PatternMatcher::new(),
        };

        db.load_default_signatures();
        db
    }

    fn load_default_signatures(&mut self) {
        // Assinaturas conhecidas de malware (exemplos simplificados)
        self.add_signature(Signature {
            id: "MAL001".to_string(),
            name: "Generic.Trojan".to_string(),
            description: "Padrão genérico de trojan".to_string(),
            pattern: vec![0x4D, 0x5A, 0x90, 0x00], // MZ header + pattern
            category: "Trojan".to_string(),
        });

        self.add_signature(Signature {
            id: "MAL002".to_string(),
            name: "Backdoor.Generic".to_string(),
            description: "Backdoor genérico".to_string(),
            pattern: b"cmd.exe /c".to_vec(),
            category: "Backdoor".to_string(),
        });

        self.add_signature(Signature {
            id: "MAL003".to_string(),
            name: "Ransomware.Crypto".to_string(),
            description: "Padrão de ransomware".to_string(),
            pattern: b"YOUR FILES ARE ENCRYPTED".to_vec(),
            category: "Ransomware".to_string(),
        });

        self.add_signature(Signature {
            id: "MAL004".to_string(),
            name: "Keylogger.Generic".to_string(),
            description: "Padrão de keylogger".to_string(),
            pattern: b"GetAsyncKeyState".to_vec(),
            category: "Keylogger".to_string(),
        });
    }

    pub fn add_signature(&mut self, signature: Signature) {
        let pattern_id = self.signatures.len();
        self.matcher.add_pattern(pattern_id, signature.pattern.clone());
        self.signatures.push(signature);
    }

    pub fn scan(&self, data: &[u8]) -> Vec<SignatureMatch> {
        let mut matches = Vec::new();

        for match_item in self.matcher.find_all(data) {
            let (pattern_id, offset) = match_item;
            if let Some(sig) = self.signatures.get(pattern_id) {
                matches.push(SignatureMatch {
                    name: sig.name.clone(),
                    description: sig.description.clone(),
                    offset,
                });
            }
        }

        matches
    }

    pub fn load_from_file(&mut self, _path: &str) -> Result<(), String> {
        // TODO: Carregar assinaturas de arquivo YARA ou formato customizado
        Ok(())
    }

    pub fn get_signature_count(&self) -> usize {
        self.signatures.len()
    }
}

impl Default for SignatureDatabase {
    fn default() -> Self {
        Self::new()
    }
}
